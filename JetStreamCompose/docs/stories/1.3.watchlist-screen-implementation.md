# Story 1.3: Watchlist Screen Implementation

## Status
Ready for Review

## Story
**As a** WilTV user,  
**I want** to access a dedicated watchlist screen showing all my saved content with the ability to remove items,  
**so that** I can easily browse my watchlist and manage my saved movies and TV shows in one place.

## Acceptance Criteria
1. Create dedicated WatchlistScreen accessible from profile section navigation
2. Display user's watchlist items in a grid layout showing both movies and TV shows  
3. Implement remove functionality allowing users to delete items from the watchlist screen
4. Show visual indicators (bookmark icons) on movie/TV show cards throughout the app
5. Integrate watchlist screen into existing navigation flow with proper TV focus handling
6. Handle empty state when user has no watchlist items

## Tasks / Subtasks
- [x] Create WatchlistScreen composable (AC: 1, 2)
  - [x] Create WatchlistScreen.kt in presentation/screens/watchlist/ following existing screen patterns
  - [x] Implement LazyVerticalGrid layout with 5 columns following SearchScreen grid pattern
  - [x] Add proper TV focus handling with FocusRequester integration
  - [x] Include empty state handling with appropriate messaging
- [x] Create WatchlistScreenViewModel (AC: 2, 3)
  - [x] Create WatchlistScreenViewModel.kt with Hilt injection
  - [x] Inject WatchlistRepository, UserRepository, MovieRepository, TvShowsRepository
  - [x] Implement getUserWatchlistItems() combining watchlist data with full movie/TV details
  - [x] Add removeFromWatchlist() method with proper error handling
  - [x] Use StateFlow for reactive watchlist state management
- [x] Integrate WatchlistScreen into navigation (AC: 1, 5)
  - [x] Add Watchlist screen to ProfileScreens enum with bookmark icon
  - [x] Update ProfileScreen.kt NavHost to include WatchlistScreen composable route
  - [x] Ensure proper navigation flow and back button handling
- [x] Implement visual indicators on cards (AC: 4)
  - [x] Update MovieCard component to accept isInWatchlist parameter
  - [x] Add bookmark overlay icons to cards when content is in watchlist
  - [x] Update movie/TV show rows to pass watchlist status to cards
  - [x] Ensure consistent visual treatment across all content cards
- [x] Add comprehensive testing
  - [x] Create WatchlistScreenViewModel unit tests following existing patterns
  - [x] Test empty state handling and error scenarios
  - [x] Verify proper navigation integration
  - [x] Test remove functionality and state updates

## Dev Notes

### Previous Story Context
From Stories 1.1 and 1.2 implementation:
- WatchlistRepository fully implemented with `getUserWatchlist(userId): Flow<List<WatchlistItem>>` method available
- WatchlistButton component created with reactive state management
- Both MovieDetailsScreenViewModel and TvShowDetailsScreenViewModel have watchlist integration
- Database schema supports both "movie" and "tvshow" content types
- Reactive Flow-based state updates already working in detail screens

### UI Architecture Context  
[Source: architecture/architecture-patterns-for-feature-development.md#ui-layer-patterns]
- Reusable UI components in `presentation/common/` package
- Screen composables with ViewModel integration using StateFlow and collectAsStateWithLifecycle
- TV-specific focus handling with FocusRequester and focusProperties
- Custom theming for TV displays with Material3 components
- Navigation patterns centralized in App.kt with parameter passing

### Project Structure Context
[Source: architecture/source-tree-and-module-organization.md#project-structure-actual]
- **Screen Location**: New files go in `presentation/screens/watchlist/`
- **Common Components**: Reusable components in `presentation/common/`
- **ViewModel Pattern**: Hilt injection with @HiltViewModel annotation
- **Navigation Integration**: Screens enum and App.kt route definitions

### Existing Grid Pattern Reference
Based on SearchScreen implementation pattern:
- **Grid Layout**: LazyVerticalGrid with GridCells.Fixed(5) for TV display
- **Card Pattern**: MovieCard component with aspectRatio(1/1.5f) for poster display
- **Content Padding**: PaddingValues with start/end margins for proper TV layout
- **Focus Navigation**: Proper focus handling for TV D-pad navigation

### Data Integration Requirements
[Source: architecture/data-models-and-apis.md#data-models]
- **WatchlistItem**: Contains userId, contentId, contentType ("movie"/"tvshow"), timestamp
- **Content Details**: Need to fetch full MovieNew or TvShow objects based on contentType
- **API Models**: Use existing MovieRepository.getMovieDetailsNew() and TvShowsRepository.getTvShowsDetails()
- **State Management**: Combine multiple repository calls into unified UI state

### Profile Screen Integration
Based on existing ProfileScreen.kt structure:
- **ProfileScreens Enum**: Add Watchlist entry with appropriate icon (Icons.Default.BookmarkBorder)
- **Sidebar Navigation**: Integrate into existing sidebar with proper focus handling  
- **NavHost**: Add composable route following existing pattern
- **Layout Pattern**: Right-side content area with fillMaxSize() modifier

### Visual Indicators Implementation
For movie/TV show cards throughout app:
- **MovieCard Component**: Extend to accept isInWatchlist: Boolean parameter
- **Bookmark Overlay**: Add bookmark icon overlay using existing ic_bookmark_filled drawable
- **State Integration**: Each card location needs watchlist status query integration
- **Consistent Styling**: Follow existing bookmark icon patterns from WatchlistButton

### Testing Requirements
[Source: architecture/testing-reality.md#current-test-coverage]
- **Test Location**: `wiltv/src/test/java/` for unit tests
- **Current Approach**: Limited unit test coverage, manual testing via Android TV emulator  
- **Required Tests**: ViewModel behavior, navigation integration, empty state handling
- **Test Command**: `./gradlew test` to run unit tests

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-25 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by development agent during implementation*

### Agent Model Used
Claude Code (claude-opus-4-1-20250805)

### Debug Log References
- Fixed FocusRequester crash by conditionally requesting focus only when watchlist has items
- Resolved compilation errors in WatchlistContentItem constructor parameter ordering
- Fixed smart cast issue by capturing uiState in local variable for LaunchedEffect
- Fixed type inference issues with watchlistItemIds.contains() calls by converting movie/TV show IDs to strings
- Resolved compilation errors for missing watchlistItemIds parameter in row components

### Completion Notes List
- Successfully created WatchlistScreen with LazyVerticalGrid layout displaying movies and TV shows
- Implemented WatchlistScreenViewModel with reactive state management combining multiple repositories
- Added Watchlist navigation to ProfileScreens enum and ProfileScreen NavHost routing
- Updated MovieCard component with isInWatchlist parameter and bookmark icon overlay
- Integrated proper TV focus handling with conditional focus requests
- Added comprehensive error handling for API failures and empty states
- Fixed focus crash issue that occurred when navigating to empty watchlist
- Successfully implemented watchlist visual indicators across all movie/TV show rows throughout the app
- Updated MoviesRow, TvShowsRow, and ImmersiveListShowsRow to support watchlist status
- Added watchlistItemIds StateFlow to HomeScreenViewModel for reactive watchlist updates on Home screen
- Added watchlistItemIds StateFlow to MoviesScreenViewModel for reactive watchlist updates on Movies screen
- Added watchlistItemIds StateFlow to TvShowScreenViewModel for reactive watchlist updates on TV Shows screen
- Connected watchlist data flow from ViewModels through CatalogLayout and TvCatalogLayout to row components to MovieCard indicators
- Extended watchlist visual indicators to Movies and TV Shows dedicated screens beyond just Home screen
- All components compile successfully and follow established architecture patterns

### File List
**Created:**
- `wiltv/src/main/java/com/google/wiltv/presentation/screens/watchlist/WatchlistScreen.kt`
- `wiltv/src/main/java/com/google/wiltv/presentation/screens/watchlist/WatchlistScreenViewModel.kt`
- `wiltv/src/test/java/com/google/wiltv/presentation/screens/watchlist/WatchlistScreenViewModelTest.kt`

**Modified:**
- `wiltv/src/main/java/com/google/wiltv/presentation/screens/profile/ProfileScreens.kt` - Added Watchlist enum entry with BookmarkBorder icon
- `wiltv/src/main/java/com/google/wiltv/presentation/screens/profile/ProfileScreen.kt` - Added WatchlistScreen route and navigation callbacks
- `wiltv/src/main/java/com/google/wiltv/presentation/common/MovieCard.kt` - Added isInWatchlist parameter and bookmark icon overlay
- `wiltv/src/main/java/com/google/wiltv/presentation/common/MoviesRow.kt` - Added isInWatchlist parameter to MoviesRowItem and MoviesRow components
- `wiltv/src/main/java/com/google/wiltv/presentation/common/TvShowsRow.kt` - Added isInWatchlist parameter to TvShowRowItem and TvShowsRow components
- `wiltv/src/main/java/com/google/wiltv/presentation/common/ImmersiveShowsList.kt` - Added isInWatchlist parameter to ShowsRowItem and ImmersiveListShowsRow components
- `wiltv/src/main/java/com/google/wiltv/presentation/common/ImmersiveListMoviesRow.kt` - Added watchlistItemIds parameter and connected to MoviesRowItem
- `wiltv/src/main/java/com/google/wiltv/presentation/common/CatalogLayout.kt` - Added watchlistItemIds parameter and passed to ImmersiveListMoviesRow calls
- `wiltv/src/main/java/com/google/wiltv/presentation/screens/home/HomeScreenViewModel.kt` - Added WatchlistRepository dependency and watchlistItemIds StateFlow
- `wiltv/src/main/java/com/google/wiltv/presentation/screens/home/HomeScreen.kt` - Added watchlist data collection and passed to CatalogLayout
- `wiltv/src/main/java/com/google/wiltv/presentation/screens/movies/MoviesScreenViewModel.kt` - Added WatchlistRepository dependency and watchlistItemIds StateFlow
- `wiltv/src/main/java/com/google/wiltv/presentation/screens/movies/MoviesScreen.kt` - Added watchlist data collection and passed to CatalogLayout
- `wiltv/src/main/java/com/google/wiltv/presentation/screens/tvshows/TvShowScreenViewModel.kt` - Added WatchlistRepository dependency and watchlistItemIds StateFlow
- `wiltv/src/main/java/com/google/wiltv/presentation/screens/tvshows/TVShowScreen.kt` - Added watchlist data collection and passed to TvCatalogLayout

## QA Results
*Results from QA Agent QA review will be added here after implementation*
# Story 1.4: Watchlist Search and Filter - Brownfield Addition

## Status
Done

## Story
**As a** WilTV user with a large watchlist,  
**I want** to search and filter my watchlist content by title and content type,  
**So that** I can quickly find specific movies or TV shows in my saved content without scrolling through everything.


## Acceptance Criteria

**Functional Requirements:**
1. Search functionality filters watchlist items by movie/TV show title with real-time results
2. Filter toggle allows users to show "All", "Movies Only", or "TV Shows Only"
3. Search and filter work together (can search within filtered results)

**Integration Requirements:**
4. Existing watchlist display and removal functionality continues to work unchanged
5. New functionality follows existing search/filter UI patterns from other screens
6. Integration with WatchlistScreenViewModel maintains current reactive state behavior

**Quality Requirements:**
7. Search and filter changes are covered by unit tests
8. No regression in existing watchlist functionality verified
9. TV remote navigation works properly with new search/filter controls

## Tasks / Subtasks

- [x] Add search and filter state to WatchlistScreenViewModel (AC: 1, 2, 3, 6)
  - [x] Add searchQuery StateFlow property for real-time search
  - [x] Add contentTypeFilter StateFlow property for Movies/TV Shows/All filtering
  - [x] Create filteredWatchlistItems computed StateFlow combining search and filter
  - [x] Ensure reactive updates when search query or filter changes
- [x] Update WatchlistScreen UI with search and filter controls (AC: 1, 2, 9)
  - [x] Add search input field above existing content grid
  - [x] Add filter toggle buttons (All/Movies/TV Shows) near search field
  - [x] Implement proper TV focus navigation for new controls
  - [x] Connect search input and filter buttons to ViewModel state
- [x] Integrate filtered results with existing grid display (AC: 3, 4)
  - [x] Update LazyVerticalGrid to use filteredWatchlistItems instead of raw watchlist
  - [x] Ensure existing remove functionality continues to work with filtered results
  - [x] Maintain proper grid layout and focus behavior with filtered content
- [x] Add comprehensive testing (AC: 7, 8)
  - [x] Unit tests for search query filtering logic
  - [x] Unit tests for content type filtering logic
  - [x] Unit tests for combined search and filter functionality
  - [x] Integration tests to verify no regression in existing remove functionality

## Dev Notes

### Previous Story Context
From Story 1.3 implementation:
- WatchlistScreen already exists with LazyVerticalGrid layout showing movies and TV shows
- WatchlistScreenViewModel has reactive state management with getUserWatchlistItems()
- Remove functionality is fully implemented and working
- Proper TV focus handling and empty state management already established

### Existing System Integration Context
- **Integrates with:** Existing WatchlistScreen and WatchlistScreenViewModel
- **Technology:** Jetpack Compose for TV, StateFlow reactive programming, Kotlin coroutines
- **Follows pattern:** Reactive state management with StateFlow (matches HomeScreenViewModel implementation)
- **Touch points:** WatchlistScreenViewModel state management, WatchlistScreen UI components

### Technical Implementation Context
[Source: architecture/architecture-patterns-for-feature-development.md#ui-layer-patterns]
- Reactive state management with StateFlow and collectAsStateWithLifecycle
- Computed StateFlow properties for derived data (filtered results)
- TV-specific focus handling with FocusRequester and focusProperties
- Search input patterns for TV interfaces with proper D-pad navigation

### Existing Pattern References
**Search/Filter UI Patterns:**
- Follow established search field patterns from other screens
- Use existing filter toggle button designs for content type selection
- Maintain consistent spacing and layout with existing watchlist grid

**State Management Patterns:**
- Use StateFlow for reactive search query and filter state
- Combine multiple StateFlow sources into computed filteredWatchlistItems
- Maintain existing error handling and loading state patterns

### Performance Considerations
- In-memory filtering of already loaded watchlist data for responsive experience
- Debounced search input to avoid excessive filtering operations
- Efficient filtering logic using Kotlin collection operations

### TV Interface Requirements
- Search field must be navigable with D-pad
- Filter buttons must integrate into existing focus navigation flow
- Clear visual focus indicators for new search/filter controls
- Proper focus restoration when returning to watchlist content grid

### Source Tree Context
**File Locations:**
- `wiltv/src/main/java/com/google/wiltv/presentation/screens/watchlist/WatchlistScreen.kt` - Existing screen to extend
- `wiltv/src/main/java/com/google/wiltv/presentation/screens/watchlist/WatchlistScreenViewModel.kt` - Existing ViewModel to extend
- `wiltv/src/test/java/com/google/wiltv/presentation/screens/watchlist/WatchlistScreenViewModelTest.kt` - Existing test file to extend

**Project Structure Reference:**
- Follow existing `presentation/screens/watchlist/` package structure
- UI components follow TV Material Design patterns from other screens
- StateFlow reactive patterns match HomeScreenViewModel implementation

### Testing

**Test File Location:**
- Unit tests: `wiltv/src/test/java/com/google/wiltv/presentation/screens/watchlist/`
- Follow existing WatchlistScreenViewModelTest.kt patterns

**Testing Standards:**
- Use existing JUnit and MockK frameworks from project
- Follow reactive testing patterns with TestCoroutineDispatcher
- Test StateFlow emissions and reactive state combinations
- Verify no regression with existing watchlist functionality

**Testing Frameworks:**
- JUnit for unit test structure
- MockK for mocking WatchlistRepository and UserRepository
- Kotlin Coroutines Test for StateFlow testing
- Follow patterns from existing WatchlistScreenViewModelTest.kt

**Specific Testing Requirements:**
- Test search query filtering with various inputs
- Test content type filter toggle (All/Movies/TV Shows)
- Test combined search and filter functionality
- Verify reactive updates when search/filter state changes
- Integration test for no regression in existing remove functionality

### Implementation Approach and Constraints

**Integration Approach:**
- Extend WatchlistScreenViewModel with search query and filter state
- Add search/filter UI above existing grid layout
- Use reactive StateFlow patterns for real-time filtering

**Key Constraints:**
- Must maintain existing TV focus navigation
- Search should be performant with large watchlists
- No breaking changes to existing APIs
- UI changes must follow established TV Material Design patterns

**Risk Assessment:**
- **Primary Risk:** Search/filter state could interfere with existing watchlist state management
- **Mitigation:** Use separate StateFlow properties for search/filter, derive filtered results reactively
- **Rollback:** Remove search/filter UI and ViewModel extensions, revert to original WatchlistScreenViewModel

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-27 | 1.0 | Initial story creation | Sarah (Product Owner) |

## Dev Agent Record
*This section has been populated by development agent during implementation*

### Agent Model Used
Claude Code (claude-opus-4-1-20250805)

### Debug Log References
- Fixed MaterialTheme.colorScheme.outline reference error by using MaterialTheme.colorScheme.onSurface.copy(alpha = 0.5f)
- Fixed search input field TV/keyboard input by adding FocusRequester, KeyboardOptions, and KeyboardActions
- Added proper TV focus handling with textFieldFocusRequester and Surface onClick to request focus
- Successfully integrated search and filter UI components following existing SearchScreen patterns
- Implemented reactive StateFlow pattern for search query and content type filter
- Combined filtering logic successfully filters items by both search query and content type

### Completion Notes List
- Successfully added searchQuery and contentTypeFilter StateFlow properties to WatchlistScreenViewModel
- Created ContentTypeFilter enum with ALL, MOVIES, TV_SHOWS options
- Implemented filterWatchlistItems function with combined search and filter logic
- Added updateSearchQuery and updateContentTypeFilter methods for reactive state updates
- Updated WatchlistScreen UI with SearchAndFilterControls component
- Created SearchInputField component following existing TV Material Design patterns
- Fixed search input keyboard functionality with proper FocusRequester and KeyboardOptions for TV interfaces
- Added FilterButtons component with proper selection states and TV focus handling
- Updated empty state message to differentiate between no items and no filtered results
- Enhanced WatchlistScreenViewModelTest with comprehensive search and filter validation tests
- All code compiles successfully and follows existing architecture patterns
- Full build passes with no errors

### File List
**Modified:**
- `wiltv/src/main/java/com/google/wiltv/presentation/screens/watchlist/WatchlistScreenViewModel.kt` - Added search and filter state management with reactive StateFlow
- `wiltv/src/main/java/com/google/wiltv/presentation/screens/watchlist/WatchlistScreen.kt` - Added search and filter UI controls with TV focus handling
- `wiltv/src/test/java/com/google/wiltv/presentation/screens/watchlist/WatchlistScreenViewModelTest.kt` - Enhanced with comprehensive search and filter tests

## QA Results
*Results from QA Agent QA review will be added here after implementation*